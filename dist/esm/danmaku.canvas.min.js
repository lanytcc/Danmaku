import*as t from"pixi.js";function i(t){return 1*window.getComputedStyle(t,null).getPropertyValue("font-size").match(/(.+)px/)[1]}function e(i,e){const n=i.style||{};let s=n.fontSize||"10px";if("string"==typeof s){const t=s.match(/(\d+(?:\.\d+)?)(px|%|em|rem)?/);let i=parseFloat(t[1]);switch(t[2]||"px"){case"%":i=i/100*e.container;break;case"em":i*=e.container;break;case"rem":i*=e.root}s=i}const r=new t.TextStyle({fontFamily:n.fontFamily||"sans-serif",fontSize:s,fill:n.fill||"#000000",stroke:n.strokeStyle||"#000000",strokeThickness:n.lineWidth||0,align:n.align||"left"}),o=new t.Text(i.text,r);switch(i.width=i.width||o.width,i.height=i.height||o.height,n.textBaseline){case"top":o.anchor.y=0;break;case"middle":o.anchor.y=.5;break;case"bottom":default:o.anchor.y=1}return o}!function(){if("undefined"==typeof document)return"transform";for(var t=["oTransform","msTransform","mozTransform","webkitTransform","transform"],i=document.createElement("div").style,e=0;e<t.length;e++)if(t[e]in i)return t[e]}();var n={name:"canvas",init:function(e){const n=new t.Application({resizeTo:e,antialias:!0,autoDensity:!0,resolution:window.devicePixelRatio||1});return e.appendChild(n.view),n._fontSize={root:i(document.getElementsByTagName("html")[0]),container:i(e)},n},clear:function(t,i){t.stage.removeChildren();for(let t=0;t<i.length;t++)i[t].pixiText=null},resize:function(t,i,e){t.renderer.resize(i,e),t.view.style.width=i+"px",t.view.style.height=e+"px"},framing:function(t){},setup:function(t,i){for(let n=0;n<i.length;n++){const s=i[n];s.pixiText=e(s,t._fontSize)}},render:function(t,i){i.pixiText.position.set(i.x,i.y),t.stage.addChild(i.pixiText)},remove:function(t,i){i.pixiText&&i.pixiText.parent&&i.pixiText.parent.removeChild(i.pixiText),i.pixiText.destroy(),i.pixiText=null}};function s(t){const i=this,e=i.media?i.media.currentTime:Date.now()/1e3,n=i.media?i.media.playbackRate:1,s=t.mode,r=t.height,o=i._.height,h=Math.floor(o/r);i._.space[s]&&i._.space[s].length===h||(i._.space[s]=new Array(h).fill(null).map(()=>({endTime:0})));const a=i._.space[s];let m=-1;function d(t,i,e,n,s,r){if(!t||!t.endTime)return!0;if(e>=t.endTime)return!0;if("ltr"===s||"rtl"===s){const o=e-t.startTime,h=e-i.time,a=r._.duration/n,m=r._.width,d=o/a*m,l=h/a*m;let u=0,c=0,p=0,f=0;if("rtl"===s?(u=r._.width-d,c=u+t.width,p=r._.width-l,f=p+i.width):(c=-t.width+d,u=c-t.width,f=-i.width+l,p=f-i.width),p<c&&f>u||f>u&&p<c)return!1}if("top"===s||"bottom"===s){const i=r._.duration/n;return e-t.startTime>=i}return!0}for(let r=0;r<h;r++){if(d(a[r],t,e,n,s,i)){m=r;break}}if(-1===m)return-1;const l=i.media?t.time:t._utc,u=l+i._.duration/n;a[m]={startTime:l,endTime:u,width:t.width,height:t.height};return"bottom"===s?o-(m+1)*r:m*r}var r="undefined"!=typeof window&&(window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)||function(t){return setTimeout(t,50/3)},o="undefined"!=typeof window&&(window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame)||clearTimeout;function h(t,i,e){for(var n=0,s=0,r=t.length;s<r-1;)e>=t[n=s+r>>1][i]?s=n:r=n;return t[s]&&e<t[s][i]?s:r}function a(t){return/^(ltr|top|bottom)$/i.test(t)?t.toLowerCase():"rtl"}function m(t){t.ltr=[],t.rtl=[],t.top=[],t.bottom=[]}function d(){if(!this._.visible||!this._.paused)return this;if(this._.paused=!1,this.media)for(var t=0;t<this._.runningList.length;t++){var i=this._.runningList[t];i._utc=Date.now()/1e3-(this.media.currentTime-i.time)}var e=this,n=function(t,i,e,n){return function(r){let o=r;void 0===o&&(o=Date.now()),t(this._.stage);const h=o/1e3,a=this.media?this.media.currentTime:h,m=this.media?this.media.playbackRate:1;let d=null,l=0,u=0;for(u=this._.runningList.length-1;u>=0;u--){d=this._.runningList[u],l=this.media?d.time:d._utc;const t=(h-d._utc)*m;let i=!1;"top"===d.mode||"bottom"===d.mode?t>this._.duration&&(i=!0):"ltr"===d.mode?d.x>this._.width&&(i=!0):"rtl"===d.mode&&d.x+d.width<0&&(i=!0),i&&(n(this._.stage,d),this._.runningList.splice(u,1))}const c=[];for(;this._.position<this.comments.length&&(d=this.comments[this._.position],l=this.media?d.time:d._utc,!(l>=a));)a-l>this._.duration||(this.media&&(d._utc=h-(this.media.currentTime-d.time)),c.push(d)),++this._.position;for(i(this._.stage,c),u=0;u<c.length;u++)d=c[u],d.y=s.call(this,d),this._.runningList.push(d);for(u=0;u<this._.runningList.length;u++){if(d=this._.runningList[u],-1===d.y)continue;const t=(h-d._utc)*m/this._.duration,i=this._.width*t;"ltr"===d.mode?d.x=-d.width+i:"rtl"===d.mode?d.x=this._.width-i:"top"!==d.mode&&"bottom"!==d.mode||(d.x=(this._.width-d.width)/2),d.element&&d.element.style&&(d.element.style.transform=`translate(${d.x}px, ${d.y}px)`),e(this._.stage,d)}}}(this._.engine.framing.bind(this),this._.engine.setup.bind(this),this._.engine.render.bind(this),this._.engine.remove.bind(this));return this._.requestID=r((function t(i){n.call(e,i),e._.requestID=r(t)})),this}function l(){return!this._.visible||this._.paused||(this._.paused=!0,o(this._.requestID),this._.requestID=0),this}function u(){if(!this.media)return this;this.clear(),m(this._.space);var t=h(this.comments,"time",this.media.currentTime);return this._.position=Math.max(0,t-1),this}function c(t){t.play=d.bind(this),t.pause=l.bind(this),t.seeking=u.bind(this),this.media.addEventListener("play",t.play),this.media.addEventListener("pause",t.pause),this.media.addEventListener("playing",t.play),this.media.addEventListener("waiting",t.pause),this.media.addEventListener("seeking",t.seeking)}function p(t){this.media.removeEventListener("play",t.play),this.media.removeEventListener("pause",t.pause),this.media.removeEventListener("playing",t.play),this.media.removeEventListener("waiting",t.pause),this.media.removeEventListener("seeking",t.seeking),t.play=null,t.pause=null,t.seeking=null}function f(t){this._={},this.container=t.container||document.createElement("div"),this.media=t.media,this._.visible=!0,this.engine="canvas",this._.engine=n,this._.requestID=0,this._.speed=Math.max(0,t.speed)||144,this._.duration=4,this.comments=t.comments||[],this.comments.sort((function(t,i){return t.time-i.time}));for(var i=0;i<this.comments.length;i++)this.comments[i].mode=a(this.comments[i].mode);return this._.runningList=[],this._.position=0,this._.paused=!0,this.media&&(this._.listener={},c.call(this,this._.listener)),this._.stage=this._.engine.init(this.container),this._.stage.style.cssText+="position:relative;pointer-events:none;",this.resize(),this.container.appendChild(this._.stage),this._.space={},m(this._.space),this.media&&this.media.paused||(u.call(this),d.call(this)),this}function _(){if(!this.container)return this;for(var t in l.call(this),this.clear(),this.container.removeChild(this._.stage),this.media&&p.call(this,this._.listener),this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=null);return this}var g=["mode","time","text","render","style"];function w(t){if(!t||"[object Object]"!==Object.prototype.toString.call(t))return this;for(var i={},e=0;e<g.length;e++)void 0!==t[g[e]]&&(i[g[e]]=t[g[e]]);if(i.text=(i.text||"").toString(),i.mode=a(i.mode),i._utc=Date.now()/1e3,this.media){var n=0;void 0===i.time?(i.time=this.media.currentTime,n=this._.position):(n=h(this.comments,"time",i.time))<this._.position&&(this._.position+=1),this.comments.splice(n,0,i)}else this.comments.push(i);return this}function v(){return this._.visible?this:(this._.visible=!0,this.media&&this.media.paused||(u.call(this),d.call(this)),this)}function y(){return this._.visible?(l.call(this),this.clear(),this._.visible=!1,this):this}function x(){return this._.engine.clear(this._.stage,this._.runningList),this._.runningList=[],this}function b(){return this._.width=this.container.offsetWidth,this._.height=this.container.offsetHeight,this._.engine.resize(this._.stage,this._.width,this._.height),this._.duration=this._.width/this._.speed,this}var T={get:function(){return this._.speed},set:function(t){return"number"!=typeof t||isNaN(t)||!isFinite(t)||t<=0?this._.speed:(this._.speed=t,this._.width&&(this._.duration=this._.width/t),t)}};function L(t){t&&f.call(this,t)}L.prototype.destroy=function(){return _.call(this)},L.prototype.emit=function(t){return w.call(this,t)},L.prototype.show=function(){return v.call(this)},L.prototype.hide=function(){return y.call(this)},L.prototype.clear=function(){return x.call(this)},L.prototype.resize=function(){return b.call(this)},Object.defineProperty(L.prototype,"speed",T);export{L as default};
