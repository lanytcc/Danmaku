!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("pixi.js")):"function"==typeof define&&define.amd?define(["pixi.js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).Danmaku=e(t.PIXI)}(this,(function(t){"use strict";function e(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var i=e(t),n=function(){if("undefined"==typeof document)return"transform";for(var t=["oTransform","msTransform","mozTransform","webkitTransform","transform"],e=document.createElement("div").style,i=0;i<t.length;i++)if(t[i]in e)return t[i];return"transform"}();function s(t){var e=document.createElement("div");if(e.style.cssText="position:absolute;","function"==typeof t.render){var i=t.render();if(i instanceof HTMLElement)return e.appendChild(i),e}if(e.textContent=t.text,t.style)for(var n in t.style)e.style[n]=t.style[n];return e}var r={name:"dom",init:function(){var t=document.createElement("div");return t.style.cssText="overflow:hidden;white-space:nowrap;transform:translateZ(0);",t},clear:function(t){for(var e=t.lastChild;e;)t.removeChild(e),e=t.lastChild},resize:function(t,e,i){t.style.width=e+"px",t.style.height=i+"px"},framing:function(){},setup:function(t,e){var i=document.createDocumentFragment(),n=0,r=null;for(n=0;n<e.length;n++)(r=e[n]).node=r.node||s(r),i.appendChild(r.node);for(e.length&&t.appendChild(i),n=0;n<e.length;n++)(r=e[n]).width=r.width||r.node.offsetWidth,r.height=r.height||r.node.offsetHeight},render:function(t,e){e.node.style[n]="translate("+e.x+"px,"+e.y+"px)"},remove:function(t,e){t.removeChild(e.node),this.media||(e.node=null)}},o="undefined"!=typeof window&&window.devicePixelRatio||1,a=Object.create(null);function h(t,e){if("function"==typeof t.render){var i=t.render();if(i instanceof HTMLCanvasElement)return t.width=i.width,t.height=i.height,i}var n=document.createElement("canvas"),s=n.getContext("2d"),r=t.style||{};r.font=r.font||"10px sans-serif",r.textBaseline=r.textBaseline||"bottom";var h=1*r.lineWidth;for(var d in h=h>0&&h!==1/0?Math.ceil(h):1*!!r.strokeStyle,s.font=r.font,t.width=t.width||Math.max(1,Math.ceil(s.measureText(t.text).width)+2*h),t.height=t.height||Math.ceil(function(t,e){if(a[t])return a[t];var i=12,n=t.match(/(\d+(?:\.\d+)?)(px|%|em|rem)(?:\s*\/\s*(\d+(?:\.\d+)?)(px|%|em|rem)?)?/);if(n){var s=1*n[1]||10,r=n[2],o=1*n[3]||1.2,h=n[4];"%"===r&&(s*=e.container/100),"em"===r&&(s*=e.container),"rem"===r&&(s*=e.root),"px"===h&&(i=o),"%"===h&&(i=s*o/100),"em"===h&&(i=s*o),"rem"===h&&(i=e.root*o),void 0===h&&(i=s*o)}return a[t]=i,i}(r.font,e))+2*h,n.width=t.width*o,n.height=t.height*o,s.scale(o,o),r)s[d]=r[d];var c=0;switch(r.textBaseline){case"top":case"hanging":c=h;break;case"middle":c=t.height>>1;break;default:c=t.height-h}return r.strokeStyle&&s.strokeText(t.text,h,c),s.fillText(t.text,h,c),n}function d(t){return 1*window.getComputedStyle(t,null).getPropertyValue("font-size").match(/(.+)px/)[1]}var c={name:"canvas",init:function(t){var e=document.createElement("canvas");return e.context=e.getContext("2d"),e._fontSize={root:d(document.getElementsByTagName("html")[0]),container:d(t)},e},clear:function(t,e){t.context.clearRect(0,0,t.width,t.height);for(var i=0;i<e.length;i++)e[i].canvas=null},resize:function(t,e,i){t.width=e*o,t.height=i*o,t.style.width=e+"px",t.style.height=i+"px"},framing:function(t){t.context.clearRect(0,0,t.width,t.height)},setup:function(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.canvas=h(n,t._fontSize)}},render:function(t,e){t.context.drawImage(e.canvas,e.x*o,e.y*o)},remove:function(t,e){e.canvas=null}};const u=window.devicePixelRatio||1;function l(t){return parseFloat(window.getComputedStyle(t).getPropertyValue("font-size"))}function m(t,e){const n={font:"10px sans-serif",fillStyle:"#ffffff",textBaseline:"bottom",...t.style},s=function(t,e){let i=10;const n=t.match(/(\d+(?:\.\d+)?)(px|%|em|rem)/);if(n){i=parseFloat(n[1]);const t=n[2];"%"===t&&(i*=e.container/100),"em"===t&&(i*=e.container),"rem"===t&&(i*=e.root)}return i}(n.font,e),r=new i.TextStyle({fontFamily:n.fontFamily||"sans-serif",fontSize:s,fill:n.fillStyle||"#ffffff",align:n.align||"left",stroke:n.strokeStyle||0,strokeThickness:n.lineWidth||0,lineJoin:"round"}),o=new i.Text(t.text,r);let a=0;switch(n.textBaseline){case"top":case"hanging":a=0;break;case"middle":a=o.height/2;break;case"bottom":default:a=o.height}return o.y-=a,t.width=o.width,t.height=o.height,o}var f={name:"pixi",init:function(t){const e=new i.Application({width:t.clientWidth,height:t.clientHeight,backgroundAlpha:0,antialias:!0,resolution:u,autoDensity:!0,autoStart:!1});return e._fontSize={root:l(document.documentElement),container:l(t)},e.view._app=e,e.view},clear:function(t,e){t._app.stage.removeChildren(),e.forEach(t=>{t.sprite=null})},resize:function(t,e,i){t._app.renderer.resize(e,i)},framing:function(t){t._app.render()},setup:function(t,e){const i=t._app;e.forEach(t=>{t.sprite=m(t,i._fontSize)})},render:function(t,e){const i=t._app;e.sprite.x=e.x,e.sprite.y=e.y,i.stage.addChild(e.sprite)},remove:function(t,e){const i=t._app;e.sprite&&(i.stage.removeChild(e.sprite),e.sprite.destroy(),e.sprite=null)}};function p(t){var e=this,i=this.media?this.media.currentTime:Date.now()/1e3,n=this.media?this.media.playbackRate:1;function s(t,s){if("top"===s.mode||"bottom"===s.mode)return i-t.time<e._.duration;var r=(e._.width+t.width)*(i-t.time)*n/e._.duration;if(t.width>r)return!0;var o=e._.duration+t.time-i,a=e._.width+s.width,h=e.media?s.time:s._utc,d=a*(i-h)*n/e._.duration,c=e._.width-d;return o>e._.duration*c/(e._.width+s.width)}for(var r=this._.space[t.mode],o=0,a=0,h=1;h<r.length;h++){var d=r[h],c=t.height;if("top"!==t.mode&&"bottom"!==t.mode||(c+=d.height),d.range-d.height-r[o].range>=c){a=h;break}s(d,t)&&(o=h)}var u=r[o].range,l={range:u+t.height,time:this.media?t.time:t._utc,width:t.width,height:t.height};return r.splice(o+1,a-o-1,l),"bottom"===t.mode?this._.height-t.height-u%this._.height:u%(this._.height-t.height)}var g="undefined"!=typeof window&&(window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)||function(t){return setTimeout(t,50/3)},_="undefined"!=typeof window&&(window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame)||clearTimeout;function v(t,e,i){for(var n=0,s=0,r=t.length;s<r-1;)i>=t[n=s+r>>1][e]?s=n:r=n;return t[s]&&i<t[s][e]?s:r}function w(t){return/^(ltr|top|bottom)$/i.test(t)?t.toLowerCase():"rtl"}function y(){var t=9007199254740991;return[{range:0,time:-t,width:t,height:0},{range:t,time:t,width:0,height:0}]}function x(t){t.ltr=y(),t.rtl=y(),t.top=y(),t.bottom=y()}function b(){if(!this._.visible||!this._.paused)return this;if(this._.paused=!1,this.media)for(var t=0;t<this._.runningList.length;t++){var e=this._.runningList[t];e._utc=Date.now()/1e3-(this.media.currentTime-e.time)}var i=this,n=function(t,e,i,n){return function(){t(this._.stage);var s=Date.now()/1e3,r=this.media?this.media.currentTime:s,o=this.media?this.media.playbackRate:1,a=null,h=0,d=0;for(d=this._.runningList.length-1;d>=0;d--)a=this._.runningList[d],r-(h=this.media?a.time:a._utc)>this._.duration&&(n(this._.stage,a),this._.runningList.splice(d,1));for(var c=[];this._.position<this.comments.length&&(a=this.comments[this._.position],!((h=this.media?a.time:a._utc)>=r));)r-h>this._.duration||(this.media&&(a._utc=s-(this.media.currentTime-a.time)),c.push(a)),++this._.position;for(e(this._.stage,c),d=0;d<c.length;d++)(a=c[d]).y=p.call(this,a),this._.runningList.push(a);for(d=0;d<this._.runningList.length;d++){a=this._.runningList[d];var u=(this._.width+a.width)*(s-a._utc)*o/this._.duration;"ltr"===a.mode&&(a.x=u-a.width+.5|0),"rtl"===a.mode&&(a.x=this._.width-u+.5|0),"top"!==a.mode&&"bottom"!==a.mode||(a.x=this._.width-a.width>>1),i(this._.stage,a)}}}(this._.engine.framing.bind(this),this._.engine.setup.bind(this),this._.engine.render.bind(this),this._.engine.remove.bind(this));return this._.requestID=g((function t(){n.call(i),i._.requestID=g(t)})),this}function T(){return!this._.visible||this._.paused||(this._.paused=!0,_(this._.requestID),this._.requestID=0),this}function k(){if(!this.media)return this;this.clear(),x(this._.space);var t=v(this.comments,"time",this.media.currentTime);return this._.position=Math.max(0,t-1),this}function L(t){t.play=b.bind(this),t.pause=T.bind(this),t.seeking=k.bind(this),this.media.addEventListener("play",t.play),this.media.addEventListener("pause",t.pause),this.media.addEventListener("playing",t.play),this.media.addEventListener("waiting",t.pause),this.media.addEventListener("seeking",t.seeking)}function C(t){this.media.removeEventListener("play",t.play),this.media.removeEventListener("pause",t.pause),this.media.removeEventListener("playing",t.play),this.media.removeEventListener("waiting",t.pause),this.media.removeEventListener("seeking",t.seeking),t.play=null,t.pause=null,t.seeking=null}function E(t){this._={},this.container=t.container||document.createElement("div"),this.media=t.media,this._.visible=!0;{const t="canvas".toLowerCase();this.engine=t,this._.engine="canvas"===t?c:"pixi"===t?f:r}this._.requestID=0,this._.speed=Math.max(0,t.speed)||144,this._.duration=4,this.comments=t.comments||[],this.comments.sort((function(t,e){return t.time-e.time}));for(var e=0;e<this.comments.length;e++)this.comments[e].mode=w(this.comments[e].mode);return this._.runningList=[],this._.position=0,this._.paused=!0,this.media&&(this._.listener={},L.call(this,this._.listener)),this._.stage=this._.engine.init(this.container),this._.stage.style?this._.stage.style.cssText+="position:relative;pointer-events:none;":this._.stage.view&&this._.stage.view.style&&(this._.stage.view.style.cssText+="position:relative;pointer-events:none;"),this.resize(),this._.stage.view?this.container.appendChild(this._.stage.view):this.container.appendChild(this._.stage),this._.space={},x(this._.space),this.media&&this.media.paused||(k.call(this),b.call(this)),this}function z(){if(!this.container)return this;for(var t in T.call(this),this.clear(),this.container.removeChild(this._.stage),this.media&&C.call(this,this._.listener),this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=null);return this}var S=["mode","time","text","render","style"];function j(t){if(!t||"[object Object]"!==Object.prototype.toString.call(t))return this;for(var e={},i=0;i<S.length;i++)void 0!==t[S[i]]&&(e[S[i]]=t[S[i]]);if(e.text=(e.text||"").toString(),e.mode=w(e.mode),e._utc=Date.now()/1e3,this.media){var n=0;void 0===e.time?(e.time=this.media.currentTime,n=this._.position):(n=v(this.comments,"time",e.time))<this._.position&&(this._.position+=1),this.comments.splice(n,0,e)}else this.comments.push(e);return this}function D(){return this._.visible?this:(this._.visible=!0,this.media&&this.media.paused||(k.call(this),b.call(this)),this)}function F(){return this._.visible?(T.call(this),this.clear(),this._.visible=!1,this):this}function O(){return this._.engine.clear(this._.stage,this._.runningList),this._.runningList=[],this}function q(){return this._.width=this.container.offsetWidth,this._.height=this.container.offsetHeight,this._.engine.resize(this._.stage,this._.width,this._.height),this._.duration=this._.width/this._.speed,this}var M={get:function(){return this._.speed},set:function(t){return"number"!=typeof t||isNaN(t)||!isFinite(t)||t<=0?this._.speed:(this._.speed=t,this._.width&&(this._.duration=this._.width/t),t)}};function P(t){t&&E.call(this,t)}return P.prototype.destroy=function(){return z.call(this)},P.prototype.emit=function(t){return j.call(this,t)},P.prototype.show=function(){return D.call(this)},P.prototype.hide=function(){return F.call(this)},P.prototype.clear=function(){return O.call(this)},P.prototype.resize=function(){return q.call(this)},Object.defineProperty(P.prototype,"speed",M),P}));
